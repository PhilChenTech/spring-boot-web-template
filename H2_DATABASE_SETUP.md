# H2 資料庫配置說明

本專案已成功整合H2內存資料庫，提供開發和測試環境下的資料持久化功能。

## 配置概覽

### 資料庫連接信息
- **資料庫URL**: `jdbc:h2:mem:testdb`
- **驅動類別**: `org.h2.Driver`
- **用戶名**: `sa`
- **密碼**: （空）

### H2 Web Console
- **訪問地址**: http://localhost:8080/h2-console
- **啟用環境**: 開發環境和默認環境
- **測試環境**: 已禁用（為了安全性）

## 配置檔案

### 1. application.yml（默認配置）
```yaml
spring:
  datasource:
    url: jdbc:h2:mem:testdb
    driver-class-name: org.h2.Driver
    username: sa
    password: 
  h2:
    console:
      enabled: true
      path: /h2-console
  jpa:
    database-platform: org.hibernate.dialect.H2Dialect
    hibernate:
      ddl-auto: create-drop
    show-sql: true
```

### 2. application-dev.yml（開發環境）
- 啟用H2 Web Console
- 詳細的SQL日誌輸出
- 允許外部訪問H2 Console

### 3. application-test.yml（測試環境）
- 禁用H2 Web Console
- 簡化日誌輸出
- 數據庫在測試期間保持連接

## 使用方式

### 1. 啟動應用程式
```bash
# 默認環境啟動
.\gradlew.bat bootRun

# 開發環境啟動
.\gradlew.bat bootRun --args='--spring.profiles.active=dev'

# 測試環境啟動
.\gradlew.bat bootRun --args='--spring.profiles.active=test'
```

### 2. 訪問H2 Web Console
1. 啟動應用程式後，打開瀏覽器訪問: http://localhost:8080/h2-console
2. 在登錄頁面輸入以下信息：
   - **JDBC URL**: `jdbc:h2:mem:testdb`
   - **User Name**: `sa`
   - **Password**: （留空）
3. 點擊"Connect"按鈕

### 3. 測試API端點

#### 基本用戶操作
```bash
# 獲取所有用戶
curl http://localhost:8080/api/users

# 根據ID獲取用戶
curl http://localhost:8080/api/users/1

# 創建新用戶
curl -X POST "http://localhost:8080/api/users" \
     -d "name=張三&email=zhangsan@example.com"
```

#### H2資料庫演示API
```bash
# 獲取資料庫統計信息
curl http://localhost:8080/api/h2-demo/stats

# 根據email域名搜尋用戶
curl "http://localhost:8080/api/h2-demo/search-by-domain?domain=@example.com"

# 創建測試用戶
curl -X POST http://localhost:8080/api/h2-demo/create-test-users

# 清空所有用戶（僅用於測試）
curl -X DELETE http://localhost:8080/api/h2-demo/clear-all
```

## 初始數據

應用程式啟動時會自動載入 `data.sql` 中的示例數據：
- 張三 (zhangsan@example.com)
- 李四 (lisi@example.com)
- 王五 (wangwu@example.com)
- 趙六 (zhaoliu@example.com)
- 管理員 (admin@nicenpc.com)

## 架構說明

### 模組分工
- **domain**: 定義User實體類別，加入JPA註解
- **adapter-outbound**: 包含UserRepository介面和資料存取邏輯
- **application**: 業務邏輯層，使用Repository進行資料操作
- **adapter-inbound**: Web層控制器，提供REST API

### 依賴關係
```
adapter-inbound -> application -> adapter-outbound -> domain
```

## 注意事項

1. **內存資料庫**: H2使用內存模式，應用程式重啟後數據會丟失
2. **適用環境**: 主要用於開發、測試和演示，生產環境建議使用持久化資料庫
3. **安全性**: 測試環境已禁用H2 Console，生產環境務必禁用
4. **性能**: 內存資料庫具有高性能，適合快速開發和測試

## 故障排除

### 常見問題
1. **無法連接H2 Console**: 確認應用程式已啟動且使用正確的JDBC URL
2. **數據不存在**: 檢查 `data.sql` 是否正確載入
3. **JPA錯誤**: 確認實體類別的JPA註解配置正確

### 日誌檢查
應用程式啟動時會輸出SQL語句，可以通過日誌檢查資料庫操作：
```
2025-08-30 23:xx:xx.xxx DEBUG 12345 --- [           main] org.hibernate.SQL                        : 
    create table users (
        id bigint generated by default as identity,
        email varchar(255) not null,
        name varchar(255) not null,
        primary key (id)
    )
```
